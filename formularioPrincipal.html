<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Dulcer&iacute;a Bomb&oacute;n Pto. Es.</title>
	<link rel="stylesheet" href="jquery-mobile/jquery.mobile-1.4.2.min.css">
	
	<link rel="shortcut icon" href="../favicon.ico">
	<script src="jquery-mobile/jquery.js"></script>
	<script src="js/index.js"></script>
	<script src="jquery-mobile/jquery.mobile-1.4.2.min.js"></script>
</head>

<body>
<style>
	label
	{
		padding-left:10px;
		font-weight:bold;
		margin-top:10px;		
	}
	
	.red
	{
		background-color:#C00 !important;
		color:white !important;
		font-weight:500 !important;
	}
	
	.cantidad, .precioU, .table-stroke div.ui-input-text
	{
		width:100px !important;		
	}
	
	.inputContainer
	{
		width:120px !important;		
	}
	
</style>
	<div data-role="header" data-theme="b">
		<h1>Nueva Orden de Compra</h1>
	</div><!-- /header -->
	<form action="javascript:guardaForm()" id="formOC">
    	
    	<h2>Seleccione Cliente:</h2>
        <select name="clienteSelect" id="clienteSelect" required="required" class="requerido"></select>
       	<div id="tablaClientes">
        </div>
    	<h2>
        	Productos
        </h2>
       <a href="#" class="ui-shadow ui-btn ui-corner-all ui-btn-inline ui-icon-plus ui-btn-icon-notext ui-btn-b ui-mini" onclick="addProducto()">icon only button</a>
        <div id="contenedorProductos">
        <table data-role="table" id="table-column-toggle-productos" data-mode="columntoggle" class="ui-responsive table-stroke">
        	<thead>
                <tr>
                    <th data-priority="1">
                    	Producto
                    </th>
                    <th data-priority="2" class="inputContainer">
                    	Cantidad
                    </th>
                     <th data-priority="3">
                    	Unidad
                    </th>
                    <th data-priority="4" class="inputContainer">
                    	Precio unitario
                    </th>
                    <th data-priority="5" class="inputContainer">
                    	Subtotal
                    </th>
                                      
                </tr>
            </thead>
            <tbody id="productosOC">
            	<tr>
                    <td>
                        <select name="1_producto" id="1_producto" class="selectProducto">
                        </select>                    
                    </td>
                    <td >
                        <input type="number" name="1_cantidad" id="1_cantidad" max="99999999" min="1" placeholder="CANTIDAD" class="cantidad" />
                    </td>
                    <td>
                    	<select name="1_unidad" id="1_unidad" class="selectUnidad">
                        </select>
                    </td>
                    <td >
                        <input type="number" name="1_precioU" id="1_precioU" max="99999999" min="1" placeholder="PRECIO U" class="precioU" readonly="readonly" />
                    </td>
                    <td>
                    	<div id="1_subtotal" class="subtotal"></div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <select name="2_producto" id="2_producto" class="selectProducto">
                        </select>                    
                    </td>
                    <td class="inputContainer">
                        <input type="number" name="2_cantidad" id="2_cantidad" max="99999999" min="1" placeholder="CANTIDAD" class="cantidad" />
                    </td>
                    <td>
                        <select name="2_unidad" id="2_unidad" class="selectUnidad"> </select>
                    </td>
                    <td class="inputContainer">
                        <input type="number" name="2_precioU" id="2_precioU" max="99999999" min="1" placeholder="PRECIO U" class="precioU" readonly="readonly" />
                    </td>
                    <td>
                    	<div id="2_subtotal" class="subtotal"></div>
                    </td>
                </tr>
            </tbody>
            <tfoot>
            	<tr>
                	<th>
                    </th>
                    <th>
                    </th>
                    <th>
                    	Total
                    </th>
                    <th>
                    	<div id="totalOC">
                        </div>
                    </th>
                </tr>
            </tfoot>
        </table>  
        </div>
        <h2>
        	Observaciones:
        </h2> 
        <textarea id="observaciones" name="observaciones" style="width:90%; height:300px; margin:0px auto;" placeholder="ESCRIBA AQUI SUS OBSERVACIONES"></textarea>
        <div id="errorMessage"></div>
        <div style="width:100%; text-align:center;" id="popOC">
            <a href="#popupLogin" data-rel="popup" data-position-to="window" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-icon-check ui-btn-icon-left ui-btn-a" data-transition="pop" style="margin-left:auto; margin-right:auto;">Guardar</a>
    <div data-role="popup" id="popupLogin" data-overlay-theme="b" data-theme="a" class="ui-corner-all">
       
            <div style="padding:10px 20px;">
                <h3>¿Realmente desea guardar?</h3>
               <a href="javascript:submitForm()" class="ui-btn ui-corner-all ui-btn-inline ui-btn-a" data-rel="back" data-transition="flow" onclick="submitForm()">Guardar</a>
                <a href="#" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-btn-b" data-rel="back">Cancelar</a>
            </div>
        </div>
   
</div>
        
    </form>
   
    <script>
			var MAYOREO = 50; //Numero de elementos para que se considere mayoreo
			/*
			carga los clientes a partir del JSON guardado en local storage para ponerlos en el select
			*/
			var atr = localStorage.getItem("Clientes");//Obtener el objeto "BD" de Local Storage
			var htmlTxt = "";
			
			if(atr== "" || atr == null || typeof atr == 'undefined')//Si nunca se ha creado, se crea con valores nulos
			{
				clientes ={"clientes": [{}]};
			}else
			{
				clientes = JSON.parse(""+atr);	
			}
			
			
			htmlTxt +="<option value=\"\">";				
			htmlTxt += "Seleccione...</option>";
			$.each(clientes['clientes'],function(i,elem){ //Se crea la lista de clientes desde el localStore
				htmlTxt +="<option value=\""+elem['idCliente']+"\">";				
				htmlTxt += ""+elem['nombre']+"</option>";					
			});
			
			$("#clienteSelect").html(htmlTxt);//Se asigna al select correspondiente
			/*
			Fin carga de cliente
			**********************************************************
			***********************************************************
			*/
			
			/*
			Función para cargar datos del cliente seleccionado en <SELECT>
			*/
			$("#clienteSelect").change(function(){
				
				/*
				carga los clientes a partir del JSON guardado en local storage
				*/
				var atr = localStorage.getItem("Clientes");//Obtener el objeto "BD" de Local Storage
				var htmlTxt = "";
				if(atr== "" || atr == null || typeof atr == 'undefined')//Si nunca se ha creado, se crea con valores nulos
				{
					myJSONObject ={"clientes": [{}]};
				}else
				{
					myJSONObject = JSON.parse(""+atr);	
				}
				/*
				Se arma el html de la tabla que contendrá los datos del cliente, se crea la tabla completa para poder inicializar el widget de la tabla de jquery mobile
				*/
				htmlTxt = ' <table data-role="table" id="table-column-toggle-clientes" data-mode="columntoggle" class="ui-responsive table-stroke">';
        		htmlTxt += '<thead>';
                htmlTxt += '<tr>';
                htmlTxt += '    <th data-priority="2">';
                htmlTxt += '   	#';
                htmlTxt += '    </th>';
                htmlTxt += '    <th data-priority="1">';
                htmlTxt += '    	Nombre';
                htmlTxt += '    </th>';
                htmlTxt += '    <th data-priority="3">';
                htmlTxt += '    	Localidad';
                htmlTxt += '    </th>';
                htmlTxt += '    <th data-priority="4">';
                htmlTxt += '    	Referencia';
                htmlTxt += '    </th>';
                htmlTxt += '    <th data-priority="5">';
                htmlTxt += '    	Tel&eacute;fono';
                htmlTxt += '    </th>                    ';
                htmlTxt += '</tr>';
            	htmlTxt += '</thead>';
            	htmlTxt += '<tbody id="myCliente">';
            	
				/*
					Se busca en el json el cliente seleccionado y se cargan sus datos en la tabla creada
				*/
				$.each(myJSONObject['clientes'],function(i,elem){
					console.log(i);
					if($("#clienteSelect").val() == elem['idCliente'])
					{
						htmlTxt +="<tr>";
						htmlTxt += "<td>"+elem['numero']+"</td>";
						htmlTxt += "<td>"+elem['nombre']+"</td>";
						htmlTxt += "<td>"+elem['localidad']+"</td>";
						htmlTxt += "<td>"+elem['referencia']+"</td>";
						htmlTxt += "<td>"+elem['telefono']+"</td>";
						htmlTxt += "</tr>";	
						htmlTxt += '</tbody>';
        				htmlTxt += '</table>';
						$("#table-column-toggle-clientes-popup-popup").remove();
						$("#tablaClientes").html(htmlTxt).enhanceWithin();
						return;
					}
				});
				
					
			});
			
			/****************************************************************************
			******************************  FIN CHANGE CLIENTE ***************************
			******************************************************************************/
			/*
				Manejo de Productos
			*/
			
			var atr = localStorage.getItem("Productos");//Obtener el objeto "BD" de Local Storage
			var htmlTxt = "";
			
			if(atr== "" || atr == null || typeof atr == 'undefined')//Si nunca se ha creado, se crea con valores nulos
			{
				productos ={"productos": [{}]};
			}else
			{
				productos = JSON.parse(""+atr);	
			}
			
			//Se llena el <select> de productos con el localStorage
			htmlTxt +="<option value=\"\">";				
			htmlTxt += "Seleccione...</option>";
			$.each(productos['productos'],function(i,elem){
				htmlTxt +="<option data-count=\""+i+"\" data-costMayor=\""+elem['precioMayoreo']+"\" data-unidad=\""+elem['unidad']+"\" data-cost=\""+elem['precio']+"\" value=\""+elem['idProducto']+"\" data-conversiones=\""+elem['conversiones']+"\">";				
				htmlTxt += ""+elem['nombre']+"</option>";					
			});
			
			$(".selectProducto").html(htmlTxt);
			
			/*
				Comportamiento del select de productos para cuando se selecciona un producto en específico
				-se agrega cantidad 1
				-se precarga el precio por unidad
			*/
			$(".selectProducto").change(function()
			{
				
				var idNum = $(this).prop("id").split("_")[0]; //Cada select está numerado secuencialmente, se obtiene ese número secuencial que identificará a todos sus hermanos
				//$(this).addClass("active");
				//$(".selectProducto:not(.active) option[value='"+$(this).val()+"']").remove();	
				//$(this).removeClass("active");
				var auxElem = $(this).find("option:selected"); // Se obtiene el <option> seleccionado por el usuario
				$("#"+idNum+"_precioU").val(auxElem.data("cost"));//Se obtiene el precio unitario del <option> seleccionado y se coloca en el input de precio
				$("#"+idNum+"_cantidad").val("1");//Se coloca la cantidad de 1
				//$("#"+idNum+"_cantidad").append(auxElem.data("unidad"));
				$("#"+idNum+"_subtotal").html(auxElem.data("cost"));//Se calcula el subtotal
				recalculaTotal();//Se calcula el total de la orden de compra
				var i = auxElem.data("count");//número de identifica el número de <option> que se selecciono .. esto se usaba para borrar dicho <option> actualmente sólo se tiene por si se reconsidera esa opción.				
				var unidades = ""; //Variable para guardar las diferentes unidad en las que se puede comprar el producto, ej. caja, bulto, saco, etc.
				unidades += "<option value=\"1\" selected=\"selected\">"+auxElem.data("unidad")+"</option>"; //Se crea el valor de conversión para la unidad inicial en la que se definió al producto... generalmente nombradas como pieza o unidad, unidad básica.. y a este se le da el valor de 1
				if(auxElem.data("conversiones") != "")//Si existen conversiones
				{
					
					var arrConver = null;//donde vamos a guardar el split de la string de conversiones
					arrConver = auxElem.data("conversiones").split(":::");
					/*
					La estructura de las conversiones es:
					
					idUnidad1||nombreUnidad1||ValorDeConversiónDeUnidad1:::idUnidad2||nombreUnidad2||ValorDeConversiónDeUnidad2
					
					*/
					
					$.each(arrConver,function(i,elem)//por cada conversion encontrada se anexa a la string que conformará el html
					{
						var auxConver = elem.split("||");
						unidades += "<option data-unidadid=\""+auxConver[0]+"\"value=\""+auxConver[2]+"\">"+auxConver[1]+"</option>";
						
					});
				}
				
				$("#"+idNum+"_unidad").html(unidades);//se anexa el html al <select> de unidades
				$("#"+idNum+"_unidad").parent().find("span").html(auxElem.data("unidad"));//Se coloca en el span de la interfaz el nombre de la unidad inicial
				
				//console.log(productos['productos']);
				//delete (productos['productos'][i]);
				//console.log(productos['productos']);
			});
			
			
			
			var countProductos=3;//Contador para identificar el número de productos agregados, por default se tienen agregados 2 <tr> con información de productos
			
			/*
				Agrega nuevo <tr> a la tabla para capturar un nuevo producto
			*/
			function addProducto()
			{
				var html = "";
				
					
					html += '<tr>';
                    html += '<td class="ui-table-priority-1">';
                    html += '    <div class="ui-select"><div id="'+countProductos+'_producto-button" class="ui-btn ui-icon-carat-d ui-btn-icon-right ui-corner-all ui-shadow"><span class="selectProducto">Seleccione...</span><select name="'+countProductos+'_producto" id="'+countProductos+'_producto" class="selectProducto cargarProductos"></select></div></div>                    ';
                    html += '</td>';
                   	html += ' <td class="ui-table-priority-2">';
                  	html += '     <div class="ui-input-text ui-body-inherit ui-corner-all ui-shadow-inset"><input type="number" name="'+countProductos+'_cantidad" id="'+countProductos+'_cantidad" max="99999999" min="1" placeholder="CANTIDAD" class="cantidad cargarCantidad"></div>';
                    html += '</td>';
					 html += '<td class="ui-table-priority-3">';
                    html += '   <select name="'+countProductos+'_unidad" id="'+countProductos+'_unidad" class="selectUnidad cargaUnidad"></select>   ';
                    html += '</td>';
                    html += ' <td class="ui-table-priority-4">';
                    html += '    <div class="ui-input-text ui-body-inherit ui-corner-all ui-shadow-inset"><input type="number" name="'+countProductos+'_precioU" id="'+countProductos+'_precioU" max="99999999" min="1" placeholder="PRECIO U" class="precioU cargarPrecioU" readonly=\"readonly\" /></div>';
                    html += '</td>';
                    html += '<td class="ui-table-priority-5">';
                    html += '	<div id="'+countProductos+'_subtotal" class="subtotal"></div>';
                    html += '</td>';
                	html += '</tr>';
					//$("#table-column-toggle-productos").remove();
					$("#productosOC").append(html);
					
					countProductos++;					
					cargaProductosSelect();
					//$("#table-column-toggle-productos");
			}
			
			/*
				Llena el <select> de productos
			*/
			function cargaProductosSelect()
			{
				console.log("cps 1");
				var htmlSelect = "";
				htmlSelect +="<option value=\" \">";				
				htmlSelect += "Seleccione...</option>";
				$.each(productos['productos'],function(i,elem){
						if(elem == "" || typeof elem == typeof undefined || elem == null)
						{
							return;	  
						}else
						{							
							htmlSelect +="<option data-count=\""+i+"\" data-cost=\""+elem['precio']+"\" data-costMayor=\""+elem['precioMayoreo']+"\" data-unidad=\""+elem['unidad']+"\" value=\""+elem['idProducto']+"\" data-conversiones=\""+elem['conversiones']+"\">";				
							htmlSelect += ""+elem['nombre']+"</option>";
						}
					}); 	
				$(".cargarProductos").html(htmlSelect);
				console.log("prepareS 1");
				prepareSelect();
			}
			
			$(".cantidad").keyup(function(){
				try
				{
					var idActual = $(this).prop("id").split("_")[0];
					var cantidad=parseFloat($(this).val());
					var unidad = parseFloat($("#"+idActual+"_unidad").val());
					cantidad = unidad * cantidad;
					
					if(cantidad == "" || typeof cantidad == typeof undefined || cantidad == null)
					{
						cantidad = 0;	
					}
					//console.log(cantidad+" ** "+MAYOREO);
					if(cantidad >= MAYOREO)
					{
						selectP = null;
						selectP = $("#"+idActual+"_producto").find("option:selected");						
						$("#"+idActual+"_precioU").val(selectP.data('costmayor'));	
					}else
					{
						selectP = null;
						selectP = $("#"+idActual+"_producto").find("option:selected");						
						$("#"+idActual+"_precioU").val(selectP.data('cost'));	
					}
					var precioU = $("#"+idActual+"_precioU").val();
					if(precioU == "" || typeof precioU == typeof undefined || precioU == null)
					{
						precioU = 0;	
					}
					
					var subtotal = parseFloat(cantidad)*parseFloat(precioU);
					$("#"+idActual+"_subtotal").html(subtotal.toFixed(2));
					recalculaTotal();
				}catch(err){}
			});
			
			$(".precioU").keyup(function(){
				try
				{
					var idActual = $(this).prop("id").split("_")[0];
					var cantidad=$("#"+idActual+"_cantidad").val();
					var unidad = parseFloat($("#"+idActual+"_unidad").val());
					cantidad = unidad * cantidad;
					if(cantidad == "" || typeof cantidad == typeof undefined || cantidad == null)
					{
						cantidad = 0;	
					}
					var precioU = $(this).val();
					if(precioU == "" || typeof precioU == typeof undefined || precioU == null)
					{
						precioU = 0;	
					}
					
					var subtotal = parseFloat(cantidad)*parseFloat(precioU);
					$("#"+idActual+"_subtotal").html(subtotal.toFixed(2));
					recalculaTotal();
				}catch(err){}
			});
			
			$(".selectUnidad").change(function(){
				try
				{
					var idActual = $(this).prop("id").split("_")[0];
					var cantidad=$("#"+idActual+"_cantidad").val();
					var unidad = parseFloat($(this).val());
					cantidad = unidad * cantidad;
					if(cantidad == "" || typeof cantidad == typeof undefined || cantidad == null)
					{
						cantidad = 0;	
					}
					if(cantidad >= MAYOREO)
					{
						selectP = null;
						selectP = $("#"+idActual+"_producto").find("option:selected");						
						$("#"+idActual+"_precioU").val(selectP.data('costmayor'));	
					}else
					{
						selectP = null;
						selectP = $("#"+idActual+"_producto").find("option:selected");						
						$("#"+idActual+"_precioU").val(selectP.data('cost'));	
					}
					
					//console.log(cantidad+" ** "+MAYOREO);
					var precioU = $("#"+idActual+"_precioU").val();
					if(precioU == "" || typeof precioU == typeof undefined || precioU == null)
					{
						precioU = 0;	
					}
					
					var subtotal = parseFloat(cantidad)*parseFloat(precioU);
					$("#"+idActual+"_subtotal").html(subtotal.toFixed(2));
					recalculaTotal();
				}catch(err){}
			});
			
			function recalculaTotal()
			{
				//console.log("recalcula");
				try
				{
					var total = 0;
					$(".subtotal").each(function(index, elem) {                    
						
						var val = $(elem).html();
						
						if(val == "" || typeof val == typeof undefined || val == null || val.length == 0)
						{
							val = 0;	
						}
						
						total += parseFloat(val);
					});
					//console.log("total: "+total); 
					$("#totalOC").html("$"+total.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,'));
				}catch(err){}
			}
			
			function prepareSelect()
			{
				
				$(".cargarProductos").unbind("change").change(function()
					{
												
						var idNum = $(this).prop("id").split("_")[0];
						$(this).parent().find("span").html($(this).find("option:selected").html());
						//$(this).addClass("active");
						//$(".selectProducto:not(.active) option[value='"+$(this).val()+"']").remove();	
						//$(this).removeClass("active");
						var auxElem = $(this).find("option:selected");
						$("#"+idNum+"_precioU").val(auxElem.data("cost"));
						$("#"+idNum+"_cantidad").val("1");
						$("#"+idNum+"_subtotal").html(auxElem.data("cost"));						
						recalculaTotal();						
						var i = auxElem.data("count");						
						var unidades = "";
						unidades += "<option data-conversion=\"1\" selected=\"selected\">"+auxElem.data("unidad")+"</option>";					
							
						if(auxElem.data("conversiones") != "")
						{							
							var arrConver = null;
							arrConver = auxElem.data("conversiones").split(":::");
							
							$.each(arrConver,function(i,elem)
							{
								var auxConver = elem.split("||");
								unidades += "<option data-unidadid=\""+auxConver[0]+"\"value=\""+auxConver[2]+"\">"+auxConver[1]+"</option>";
								
							});
						}
						
						$("#"+idNum+"_unidad").html(unidades);
						$("#"+idNum+"_unidad").parent().find("span").html(auxElem.data("unidad"));
						$("#"+idNum+"_unidad").selectmenu();
						//console.log(productos['productos']);
						//delete (productos['productos'][i]);
						//console.log(productos['productos']);
					});
					$(".cargarProductos").removeClass("cargarProductos");
					$(".cargarCantidad").keyup(function(){
					try
					{
						var idActual = $(this).prop("id").split("_")[0];
						var cantidad=$(this).val();
						var unidad = parseFloat($("#"+idActual+"_unidad").val());
						cantidad = unidad * cantidad;
						if(cantidad == "" || typeof cantidad == typeof undefined || cantidad == null)
						{
							cantidad = 0;	
						}
						var precioU = $("#"+idActual+"_precioU").val();
						if(precioU == "" || typeof precioU == typeof undefined || precioU == null)
						{
							precioU = 0;	
						}
						
						var subtotal = parseFloat(cantidad)*parseFloat(precioU);
						$("#"+idActual+"_subtotal").html(subtotal.toFixed(2));
						recalculaTotal();
					}catch(err){}
				});
				$(".cargarCantidad").removeClass("cargarCantidad");
				$(".cargarPrecioU").keyup(function(){
					try
					{
						var idActual = $(this).prop("id").split("_")[0];
						var cantidad=$("#"+idActual+"_cantidad").val();
						var unidad = parseFloat($("#"+idActual+"_unidad").val());
						cantidad = unidad * cantidad;
						if(cantidad == "" || typeof cantidad == typeof undefined || cantidad == null)
						{
							cantidad = 0;	
						}
						var precioU = $(this).val();
						if(precioU == "" || typeof precioU == typeof undefined || precioU == null)
						{
							precioU = 0;	
						}
						
						var subtotal = parseFloat(cantidad)*parseFloat(precioU);
						$("#"+idActual+"_subtotal").html(subtotal.toFixed(2));
						recalculaTotal();
					}catch(err){}
				});
				$(".cargarPrecioU").removeClass("cargarPrecioU");
				$(".cargaUnidad").unbind("change").change(function(){
					try
					{
						var idActual = $(this).prop("id").split("_")[0];
						var cantidad=$("#"+idActual+"_cantidad").val();
						var unidad = parseFloat($(this).val());
						cantidad = unidad * cantidad;
						if(cantidad == "" || typeof cantidad == typeof undefined || cantidad == null)
						{
							cantidad = 0;	
						}
						var precioU = $("#"+idActual+"_precioU").val();
						if(precioU == "" || typeof precioU == typeof undefined || precioU == null)
						{
							precioU = 0;	
						}
						
						var subtotal = parseFloat(cantidad)*parseFloat(precioU);
						$("#"+idActual+"_subtotal").html(subtotal.toFixed(2));
						recalculaTotal();
					}catch(err){}
				});
				$(".cargaUnidad").removeClass("cargaUnidad");
			}
		
		var todobien = true;
		function guardaForm()
		{
			todobien=true;
			var mensaje="";
			var myJSON = "";
			var countProductosActivos=0;
			var idCliente = $("#clienteSelect").val();
			var now = new Date();
			var fecha = now.getFullYear()+"-"+(now.getMonth()+1)+"-"+ now.getDate()+" "+now.getHours()+":"+now.getMinutes();
			//console.log(fecha);
			//console.log("cliente: "+idCliente+" :: "+typeof idCliente);
			if(idCliente=="")
			{
				mensaje += '<a href="#" class="ui-btn ui-corner-all ui-icon-delete ui-btn-icon-left red">Debe seleccionar un cliente</a>';
				todobien = false;	
			}
			myJSON = '"productos":[';
			$(".selectProducto").each(function(i,elem){
				var id = $(this).prop("id").split("_")[0];
				try
				{
				if($(this).val() != "" && ($("#"+id+"_cantidad").val() == "" || $("#"+id+"_precioU").val() == "" || parseFloat($("#"+id+"_cantidad").val())<=0 || parseFloat($("#"+id+"_precioU").val())<= 0))
				{
					todobien = false;
					mensaje += '<a href="#" class="ui-btn ui-corner-all ui-icon-delete ui-btn-icon-left red">Debe proporcionar valores validos para cantidad y precio unitario</a>';
				}else if($(this).val()!="")//hubo por lo menos un producto seleccionado
				{
					if(countProductosActivos++>0)
						myJSON += ",";
					myJSON += '{"idProducto":"'+$(this).val()+'","cantidad":"'+$("#"+id+"_cantidad").val()+'","precioUnitario":"'+$("#"+id+"_precioU").val()+'"}';
				}
				}catch(err){console.log(err)}
			});
			myJSON += "]";
			if(countProductosActivos==0)
			{
				todobien = false;
				mensaje += '<a href="#" class="ui-btn ui-corner-all ui-icon-delete ui-btn-icon-left red">Debe ingresar por lo menos un producto</a>';
			}	
			
			if(!todobien)
			{
				$("#errorMessage").html(mensaje);
				return;	
			}else
			{
				$("#errorMessage").html('');	
			}
			
			
			
			var params=$("form").serialize().split("&");
			//console.log("len: "+ );
			myJSON ='{"idCliente":"'+idCliente+'","fecha":"'+fecha+'","idPromotor":"","comentarios":"'+params[params.length-1].split("=")[1]+'",'+myJSON+"}";
			/*
			Traer elemento de localstorage para guardar la nueva orden de compra
			/*/
			
			var atr = localStorage.getItem("OC");//Obtener el objeto "OC" ordenes de compra de Local Storage
			
			var htmlTxt = "";
			if(atr== "" || atr == null || typeof atr == 'undefined')//Si nunca se ha creado, se crea con valores nulos
			{
				myJSONObject ={"oc":[{}]};
			}else
			{
				myJSONObject = JSON.parse(""+atr);	
			}
			myJSONObject['oc'].push($.parseJSON(myJSON));
			
			//console.log(myJSONObject);
			
			window.localStorage.setItem("OC",JSON.stringify(myJSONObject) );
			$("#popOC").html("Guardado correctamente");
			window.location = "formularioPrincipal.html";
			
			
		}
		
		function submitForm()
		{
			$("#formOC").submit();	
		}
	</script>
    
    
</body>
</html>
